<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Classifier</title>

    <!-- =========================
         Favicon da aplicação
         ========================= -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- =========================
         Link para o CSS da página
         ========================= -->
    <link rel="stylesheet" href="/app/style.css">

    <!-- (Opcional) Se front e back estiverem em DOMÍNIOS DIFERENTES,
         descomente e ajuste a meta abaixo:
         <meta name="backend-url" content="https://SEU-BACKEND.onrender.com">
    -->
</head>
<body>
    <div class="container">
        <h1>Email Classifier</h1>

        <textarea id="emailText" placeholder="Cole o texto do email aqui..."></textarea>

        <input type="file" id="emailFile" accept=".txt,.pdf">

        <button id="submitBtn">Classificar Email</button>

        <div id="result">
            <h2>Categoria: <span id="category">---</span></h2>
            <h3>Resposta Sugerida:</h3>
            <p id="response">---</p>
        </div>
    </div>

    <script>
        // =========================
        // Descoberta de BACKEND_URL
        // - Se houver <meta name="backend-url" ...> usa ela (domínios separados)
        // - Caso contrário, usa rotas relativas (mesma origem -> sem CORS)
        // =========================
        function getBackendBase() {
            const meta = document.querySelector('meta[name="backend-url"]');
            const configured = meta && meta.getAttribute("content");
            return configured ? configured.replace(/\/+$/, "") : "";
        }
        const BACKEND_BASE = getBackendBase();

        // =========================
        // Envio de texto/arquivo
        // =========================
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const emailText = document.getElementById('emailText').value.trim();
            const emailFile = document.getElementById('emailFile').files[0];

            try {
                let response;
                if (emailText) {
                    const url = (BACKEND_BASE || "") + "/process";
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Importante: SEM credentials: 'include' (não usamos cookies)
                        body: JSON.stringify({ text: emailText })
                    });
                } else if (emailFile) {
                    const formData = new FormData();
                    formData.append('file', emailFile);
                    const url = (BACKEND_BASE || "") + "/process-file";
                    response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    alert("Por favor, insira o texto ou envie um arquivo.");
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                document.getElementById('category').innerText = data.category || '---';
                document.getElementById('response').innerText = data.suggested_response || '---';

            } catch (error) {
                console.error("Erro ao processar o email:", error);
                alert("Erro ao processar o email. Veja o console para mais detalhes.");
            }
        });
    </script>
</body>
</html>
